<link rel="import" href="../bower_components/polymer/polymer-element.html">

<!-- app layout elements -->
<link rel="import" href="../bower_components/app-layout/app-toolbar/app-toolbar.html">
<link rel="import" href="../bower_components/iron-pages/iron-pages.html">

<!-- google maps -->
<link rel="import" href="../bower_components/google-map/google-map.html">
<link rel="import" href="../bower_components/google-map/google-map-marker.html">

<!-- app routing -->
<link rel="import" href="../bower_components/app-route/app-location.html">
<link rel="import" href="../bower_components/app-route/app-route.html">

<!-- icons and buttons -->
<link rel="import" href="../bower_components/paper-icon-button/paper-icon-button.html">
<link rel="import" href="../bower_components/iron-icon/iron-icon.html">
<link rel="import" href="../bower_components/iron-icons/iron-icons.html">
<link rel="import" href="../bower_components/iron-icons/maps-icons.html">
<link rel="import" href="../bower_components/iron-icons/social-icons.html">
<link rel="import" href="../bower_components/iron-icons/image-icons.html">

<!-- firebase -->
<script src="../bower_components/firebase/firebase.js"></script>
<script src="../bower_components/geofire/dist/geofire.min.js"></script>

<!-- custom view components -->
<link rel="import" href="./add-view.html">
<link rel="import" href="./detail-view.html">

<dom-module id="pupalert-app">
  <template>
    <style>
      :host {
        margin: 0;
        height: 100vh;
        width: 100vw;
      }
      app-toolbar {
        background-color: white;
        color: #555555;
        justify-content: space-around;
        position: fixed;
        bottom: 0;
        left: 0;
        right: 0;
      }
      iron-pages {
        height: 100vh;
        width: 100vw;
      }
      a {
        color: inherit;
        text-decoration: none;
      }
    </style>

    <!-- binds to the app's url -->
    <app-location route="{{route}}"></app-location>

    <!-- manages top-level routes -->
    <app-route
      route="{{route}}"
      pattern="/:page"
      data="{{routeData}}"
      tail="{{subroute}}"
    ></app-route>

    <!-- manages which route to display -->
    <iron-pages
      selected="[[routeData.page]]"
      attr-for-selected="name"
    >
      <google-map
        name="map"
        disable-default-ui
        api-key="AIzaSyBlkjDPZDLLDqbUvidvTpV0T8Pjknl5Tbk"
        latitude="{{lat}}"
        longitude="{{lng}}"
        zoom="{{mapZoom}}"
      >
        <template
          is="dom-repeat"
          items="[[points]]"
        >
          <google-map-marker
            latitude="[[item.lat]]"
            longitude="[[item.lng]]"
            click-events
            on-google-map-marker-click="_toggleInfoWindow"
            id="[[item.id]]"
          ></google-map-marker>
        </template>
      </google-map>

      <div name="list">list</div>
      <add-view
        name="add"
        lat="[[lat]]"
        lng="[[lng]]"
      ></add-view>
      <div name="profile">I'm profile view!</div>
      <detail-view
        name="detail"
        postid="[[subroute.path]]"
      ></detail-view>
    </iron-pages>

    <!-- bottom toolbar -->
    <app-toolbar>
      <a href="/map" tabindex="-1"><paper-icon-button icon="maps:map" title="Map"></paper-icon-button></a>
      <a href="/list" tabindex="-1"><paper-icon-button icon="view-list" title="List"></paper-icon-button></a>
      <a href="/add" tabindex="-1"><paper-icon-button icon="maps:add-location" title="Camera"></paper-icon-button></a>
      <a href="/profile" tabindex="-1"><paper-icon-button icon="social:person" title="Profile"></paper-icon-button></a>
    </app-toolbar>
  </template>

  <script>
    class PupalertApp extends Polymer.Element {
      static get is() { return 'pupalert-app' }

      static get properties() {
        return {
          lat: Number,
          lng: Number,
          mapZoom: Number,
          points: {
            type: Array,
            value: []
          }
        }
      }

      static get observers() {
        return [
          '_mapChanged(lat, lng, mapZoom)'
        ]
      }

      constructor() {
        super()

        // init firebase
        firebase.initializeApp({
          apiKey: 'AIzaSyAwCPLC9IY8bZilAE-R7Qot_cLGg4Addoo',
          databaseURL: 'https://pupalert-f3b79.firebaseio.com/',
          storageBucket: 'gs://pupalert-f3b79.appspot.com/'
        })
        // create a new geofire instance
        this.geoFire = new GeoFire(firebase.database().ref('geofire'))
      }

      _mapChanged(lat, lng, mapZoom) {
        if (this.route.path === '/map' || this.route.path === '/list') {
          let geoQuery = this.geoFire.query({
            center: [lat, lng],
            // FIX vvv
            radius: Math.pow(14 - mapZoom, 2) * 1.60934 // km, magic formula from http://jeffjason.com/2011/12/google-maps-radius-to-zoom/
          }).on('key_entered', (key, location, distance) => {
            this.push('points', {
              lat: location[0],
              lng: location[1],
              id: key
            })
          })
        }
      }

      _toggleInfoWindow(e) {
        this.set('route.path', `/detail/${e.target.id}`)
      }
    }

    customElements.define(PupalertApp.is, PupalertApp)
  </script>
</dom-module>
