<link rel="import" href="../bower_components/polymer/polymer-element.html">
<link rel="import" href="../bower_components/paper-button/paper-button.html">
<link rel="import" href="../bower_components/paper-toast/paper-toast.html">


<dom-module id="add-view">
  <template>
    <style>
      :host {
        display: flex;
        flex-direction: column;
        margin: 0 auto;
        height: 100%;
        justify-content: space-evenly;
        align-items: center;
      }
      input {
        width: 0px;
        height: 0px;
        overflow: hidden;
      }
      input + label {
        display: inline-block;
        cursor: pointer;
        background-color: indigo;
        color: white;
        padding: 1em;
        border-radius: 4px;
        text-transform: uppercase;
      }
      input:focus + label {
        outline: 2px solid royalblue;
      }
      img {
        height: 200px;
        width: 200px;
        border-radius: 4px;
      }
      paper-button {
        display: block;
        background-color: indigo;
        color: white;
        text-align: center;
      }
    </style>

    <input
      id="userPic"
      type="file"
      accept="image/*"
      capture
      on-change="_displayPic"
    >
    <label for="userPic">Take picture</label>

    <img src="[[picture]]">
    <p>[[user.displayName]]</p>

    <paper-button
      raised
      on-click="_handleSubmit"
    >Add</paper-button>

    <paper-toast
      id="postAdded"
      text="Post added."
    ></paper-toast>
    <paper-toast
      id="noUser"
      text="You must sign in to post."
    ></paper-toast>
  </template>
  <script>
    class AddView extends Polymer.Element {
      static get is() { return 'add-view' }

      static get properties() {
        return {
          picture: {
            type: Object,
            value: '../images/pup.jpg'
          },
          lat: Object,
          lng: Object,
          user: Object,
        }
      }

      constructor() {
        super()

        this.geoFire = new GeoFire(firebase.database().ref('geofire'))
      }

      _displayPic() {
        this.picture = URL.createObjectURL(this.$.userPic.files[0])
      }

      async _handleSubmit() {
        // make a new post, upload to /posts
        const post = await firebase.database().ref('posts').push()

        // set post data
        post.set({
          timestamp: (new Date()).toString(),
          postedBy: this.user.uid
        })

        // upload photo to storage if one is supplied
        if (this.picture != '../images/pup.jpg') {
          await firebase.storage().ref('posts')
            .child(post.key)
            .put(this.$.userPic.files[0])
            .then(() => {
              this.$.postAdded.open()
            })
        }

        // upload point to geoFire
        this.geoFire.set(post.key, [this.lat, this.lng])
          .then(() => this.$.postAdded.open())
      }
    }

    customElements.define(AddView.is, AddView)
  </script>
</dom-module>